{% extends "delivery_app/base.html" %}
{% load static %}

{% block title %}
–û—Ç–∑—ã–≤—ã –æ –Ω–∞—à–µ–π —Å–ª—É–∂–±–µ –¥–æ—Å—Ç–∞–≤–∫–∏
{% endblock %}

{% block content %}
<div class="reviews-container">
    <div class="page-header">
        <h1>–û—Ç–∑—ã–≤—ã –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</h1>
        <p class="page-subtitle">–ú—ã —Ü–µ–Ω–∏–º –º–Ω–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ —É–ª—É—á—à–µ–Ω–∏–µ–º –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞</p>
        <p class="current-date">–î–∞—Ç–∞: {{ current_date }} | –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞: {{ timezone }}</p>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ -->
    <div class="reviews-stats">
        <div class="stats-card">
            <div class="stats-icon">‚≠ê</div>
            <div class="stats-content">
                <h3>{{ average_rating|default:"5.0" }}/5</h3>
                <p>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</p>
            </div>
        </div>
        <div class="stats-card">
            <div class="stats-icon">üí¨</div>
            <div class="stats-content">
                <h3>{{ reviews.count }}</h3>
                <p>–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤</p>
            </div>
        </div>
        <div class="stats-card">
            <div class="stats-icon">üòä</div>
            <div class="stats-content">
                <h3>{{ positive_reviews }}+</h3>
                <p>–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤</p>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
    <div class="add-review-section">
        {% if user.is_authenticated %}
            <button class="btn btn-primary btn-large" id="showReviewForm">
                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
            </button>
        {% else %}
            <div class="auth-required">
                <p>–ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å</p>
                <div class="auth-buttons">
                    <a href="{% url 'delivery_app:login' %}?next={{ request.path }}" class="btn btn-primary">–í–æ–π—Ç–∏</a>
                    <a href="{% url 'delivery_app:register' %}?next={{ request.path }}" class="btn btn-outline">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    {% if user.is_authenticated %}
    <div class="review-form-container" id="reviewFormContainer" style="display: none;">
        <div class="review-form">
            <h3>–û—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤</h3>
            <form method="post" action="{% url 'delivery_app:add_review' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label>–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞</label>
                    <div class="rating-stars">
                        <input type="radio" id="star5" name="rating" value="5" />
                        <label for="star5">‚òÖ</label>
                        <input type="radio" id="star4" name="rating" value="4" />
                        <label for="star4">‚òÖ</label>
                        <input type="radio" id="star3" name="rating" value="3" checked />
                        <label for="star3">‚òÖ</label>
                        <input type="radio" id="star2" name="rating" value="2" />
                        <label for="star2">‚òÖ</label>
                        <input type="radio" id="star1" name="rating" value="1" />
                        <label for="star1">‚òÖ</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="reviewText">–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞</label>
                    <textarea id="reviewText" name="text" rows="5" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º –æ–ø—ã—Ç–æ–º..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="reviewProduct">–û—Ç–∑—ã–≤ –æ —Ç–æ–≤–∞—Ä–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <select id="reviewProduct" name="product">
                        <option value="">–û–±—â–∏–π –æ—Ç–∑—ã–≤ –æ —Å–ª—É–∂–±–µ –¥–æ—Å—Ç–∞–≤–∫–∏</option>
                        {% for product in products %}
                        <option value="{{ product.id }}">{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancelReview">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
    <div class="reviews-filters">
        <div class="filter-group">
            <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
            <select id="sortReviews">
                <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                <option value="oldest">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                <option value="highest">–í—ã—Å–æ–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥</option>
                <option value="lowest">–ù–∏–∑–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–§–∏–ª—å—Ç—Ä –ø–æ –æ—Ü–µ–Ω–∫–µ:</label>
            <div class="rating-filter">
                <button class="filter-btn active" data-rating="all">–í—Å–µ</button>
                <button class="filter-btn" data-rating="5">5‚òÖ</button>
                <button class="filter-btn" data-rating="4">4‚òÖ</button>
                <button class="filter-btn" data-rating="3">3‚òÖ</button>
                <button class="filter-btn" data-rating="2">2‚òÖ</button>
                <button class="filter-btn" data-rating="1">1‚òÖ</button>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
    <div class="reviews-list">
        {% for review in reviews %}
        <div class="review-card" data-rating="{{ review.rating }}">
            <div class="review-header">
                <div class="reviewer-info">
                    <div class="reviewer-avatar">
                        {{ review.user.username|first|upper }}
                    </div>
                    <div class="reviewer-details">
                        <h4>{{ review.user.username }}</h4>
                        <span class="review-date">{{ review.created_date|date:"d.m.Y" }}</span>
                    </div>
                </div>
                <div class="review-rating">
                    {% for i in "12345" %}
                    <span class="star{% if forloop.counter <= review.rating %} filled{% endif %}">‚òÖ</span>
                    {% endfor %}
                </div>
            </div>
            
            <div class="review-content">
                <p>{{ review.text }}</p>
            </div>
            
            {% if review.product %}
            <div class="review-product">
                <span>–û—Ç–∑—ã–≤ –æ —Ç–æ–≤–∞—Ä–µ:</span>
                <a href="{% url 'delivery_app:product_detail' review.product.id %}">{{ review.product.name }}</a>
            </div>
            {% endif %}
            
            <div class="review-helpful">
                <span>–û—Ç–∑—ã–≤ –ø–æ–ª–µ–∑–µ–Ω?</span>
                <button class="helpful-btn" data-review-id="{{ review.id }}">
                    <i class="fas fa-thumbs-up"></i> –î–∞
                    <span class="helpful-count">{% if review.helpful_count %}{{ review.helpful_count }}{% else %}0{% endif %}</span>
                </button>
            </div>
        </div>
        {% empty %}
        <div class="no-reviews">
            <div class="empty-state">
                <img src="{% static 'delivery_app/images/empty-reviews.svg' %}" alt="–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤">
                <h3>–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç –æ—Ç–∑—ã–≤ –æ –Ω–∞—à–µ–π —Å–ª—É–∂–±–µ –¥–æ—Å—Ç–∞–≤–∫–∏!</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if reviews.has_other_pages %}
    <div class="pagination">
        {% if reviews.has_previous %}
        <a href="?page={{ reviews.previous_page_number }}" class="page-link">
            <i class="fas fa-chevron-left"></i>
        </a>
        {% endif %}
        
        {% for i in reviews.paginator.page_range %}
        {% if reviews.number == i %}
        <span class="page-link current">{{ i }}</span>
        {% else %}
        <a href="?page={{ i }}" class="page-link">{{ i }}</a>
        {% endif %}
        {% endfor %}
        
        {% if reviews.has_next %}
        <a href="?page={{ reviews.next_page_number }}" class="page-link">
            <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
.reviews-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c5aa0;
    margin-bottom: 10px;
}

.page-subtitle {
    color: #6c757d;
    font-size: 1.1em;
    margin-bottom: 15px;
}

.current-date {
    color: #6c757d;
    font-size: 0.9em;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.reviews-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stats-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stats-icon {
    font-size: 2em;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 50%;
}

.stats-content h3 {
    margin: 0;
    color: #2c5aa0;
    font-size: 1.8em;
}

.stats-content p {
    margin: 5px 0 0;
    color: #6c757d;
}

/* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ */
.add-review-section {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
}

.auth-required p {
    margin-bottom: 15px;
    color: #6c757d;
}

.auth-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
}

/* –§–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞ */
.review-form-container {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.review-form h3 {
    margin-top: 0;
    color: #2c5aa0;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
}

.rating-stars {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
}

.rating-stars input {
    display: none;
}

.rating-stars label {
    font-size: 2em;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s;
    margin-right: 5px;
}

.rating-stars input:checked ~ label,
.rating-stars label:hover,
.rating-stars label:hover ~ label {
    color: #ffc107;
}

.rating-stars input:checked + label {
    color: #ffc107;
}

textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.3s;
}

textarea:focus {
    outline: none;
    border-color: #2c5aa0;
}

select {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
    transition: border-color 0.3s;
}

select:focus {
    outline: none;
    border-color: #2c5aa0;
}

.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* –§–∏–ª—å—Ç—Ä—ã */
.reviews-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
    padding: 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.filter-group label {
    font-weight: 500;
}

#sortReviews {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.rating-filter {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
}

.filter-btn.active,
.filter-btn:hover {
    background: #2c5aa0;
    color: white;
    border-color: #2c5aa0;
}

/* –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ */
.reviews-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 30px;
}

.review-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.reviewer-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.reviewer-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #2c5aa0;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2em;
}

.reviewer-details h4 {
    margin: 0 0 5px;
    color: #2c5aa0;
}

.review-date {
    color: #6c757d;
    font-size: 0.9em;
}

.review-rating {
    display: flex;
    gap: 2px;
}

.star {
    color: #ddd;
    font-size: 1.2em;
}

.star.filled {
    color: #ffc107;
}

.review-content {
    margin-bottom: 15px;
    line-height: 1.6;
}

.review-product {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 15px;
    font-size: 0.9em;
}

.review-product a {
    color: #2c5aa0;
    font-weight: 500;
}

.review-helpful {
    display: flex;
    align-items: center;
    gap: 10px;
}

.review-helpful span {
    color: #6c757d;
    font-size: 0.9em;
}

.helpful-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
}

.helpful-btn:hover {
    background: #e9ecef;
}

.helpful-count {
    background: #2c5aa0;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 0.8em;
}

/* –ü—É—Å—Ç–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
.no-reviews {
    text-align: center;
    padding: 40px 0;
}

.empty-state img {
    max-width: 200px;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: #6c757d;
    margin-bottom: 10px;
}

/* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
.pagination {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-top: 30px;
}

.page-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: 1px solid #ddd;
    border-radius: 5px;
    color: #2c5aa0;
    text-decoration: none;
    transition: all 0.3s;
}

.page-link:hover {
    background: #f8f9fa;
}

.page-link.current {
    background: #2c5aa0;
    color: white;
    border-color: #2c5aa0;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .reviews-stats {
        grid-template-columns: 1fr;
    }
    
    .review-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .reviews-filters {
        flex-direction: column;
    }
    
    .auth-buttons {
        flex-direction: column;
    }
    
    .form-actions {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –æ—Ç–∑—ã–≤–∞
    const showReviewFormBtn = document.getElementById('showReviewForm');
    const reviewFormContainer = document.getElementById('reviewFormContainer');
    const cancelReviewBtn = document.getElementById('cancelReview');
    
    if (showReviewFormBtn && reviewFormContainer) {
        showReviewFormBtn.addEventListener('click', function() {
            reviewFormContainer.style.display = 'block';
            showReviewFormBtn.style.display = 'none';
        });
    }
    
    if (cancelReviewBtn && reviewFormContainer) {
        cancelReviewBtn.addEventListener('click', function() {
            reviewFormContainer.style.display = 'none';
            if (showReviewFormBtn) showReviewFormBtn.style.display = 'block';
        });
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
    const filterButtons = document.querySelectorAll('.filter-btn');
    const reviewCards = document.querySelectorAll('.review-card');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
            this.classList.add('active');
            
            const rating = this.getAttribute('data-rating');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ—Ç–∑—ã–≤—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–π—Ç–∏–Ω–≥–∞
            reviewCards.forEach(card => {
                if (rating === 'all' || card.getAttribute('data-rating') === rating) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç–∑—ã–≤–æ–≤
    const sortSelect = document.getElementById('sortReviews');
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–æ–±—ã—á–Ω–æ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏)
            const sortBy = this.value;
            window.location.href = `?sort=${sortBy}`;
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–û—Ç–∑—ã–≤ –ø–æ–ª–µ–∑–µ–Ω"
    const helpfulButtons = document.querySelectorAll('.helpful-btn');
    helpfulButtons.forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.getAttribute('data-review-id');
            const countElement = this.querySelector('.helpful-count');
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            this.disabled = true;
            this.style.opacity = '0.7';
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç AJAX-–∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
            setTimeout(() => {
                let count = parseInt(countElement.textContent);
                count++;
                countElement.textContent = count;
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ "–æ—Ç–ø—Ä–∞–≤–∫–∏"
                this.innerHTML = '<i class="fas fa-check"></i> –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≥–æ–ª–æ—Å!';
            }, 500);
        });
    });
});
</script>
{% endblock %}